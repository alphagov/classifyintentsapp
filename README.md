# Classify intents survey web app

This repository contains a Flask app designed to improve the process of classifying surveys received in the GOV.UK intents survey.

The app is hosted at [https://classifyintents.herokuapp.com](https://classifyintents.herokuapp.com)


A blog about the survey is available on [gov.uk](https://gdsdata.blog.gov.uk/2016/12/20/using-machine-learning-to-classify-user-comments-on-gov-uk/), whilst the code is available as a [python package](https://github.com/ukgovdatascience/classifyintents) and [supporting scripts](https://github.com/ukgovdatascience/classifyintentspipe).

The underlying framework of the app is based heavily on the micro blogging site by [Miguel Grinberg](https://github.com/miguelgrinberg/flasky) which features in the O'Reilly book [Flask Web Development](http://www.flaskbook.com).

## Gettting started

### Environmental variables

It is adviseable to use [autoenv](https://github.com/kennethreitz/autoenv) to manage environmental variables. 

Install with: `pip install autoenv`, and then set all environmental variables in a `.env` files.

The following variables should be set in `.env`:

* __MAIL_USERNAME__: Email username used for sending confirmations when signing up.
* __MAIL_PASSWORD__: Password for above email account (probably a gmail account)
* __DEV_DATABASE_URL__: URL of the database used for development
* __DATABASE_URL__: URL of production database.

Note that `DATABASE_URL` is subject to change if deployed on heroku, and for this reason should be set dynamically following 12 factor app principles with:

```
DATABASE_URL=$(heroku config:get DATABASE_URL -a classifyintents)
```

See [heroku docs](https://devcenter.heroku.com/articles/connecting-to-heroku-postgres-databases-from-outside-of-heroku) for more details.

### Setting up the app

* Set up a heroku pipeline to detect pushes on master to github
* Push to github, heroku will detect, and build the app
* Run `heroku run python manage.py deploy` to run deployment tasks on the servera
* You will probably need to drop the priority table that is created from a psql console with `drop table priority;` then `\i sql/views/priority.sql` to create a priority view in its place.

Following changes to the database migrations can be made with:

```
python manage.py db migrate 
python manage.py db upgrade
```

### Generating dummy data

There are `generate_fake()` methods on the `Raw`, `Codes`, `ProjectCodes`, and `Classified` models.
To generate fake data, first create an app specific shell with `python manage.py shell`, then run the methods with:

```
Raw.generate_fake()
Codes.generate_fake()
ProjectCodes.generate_fake()
Classified.generate_fake()
Users.generate_fake()
```

You can specify the number of fake records to be insert with an integer argument (e.g. 100) to each method.

Note that `Raw.generate_fake()` will use real GOV.UK urls from the <govukurls.txt> file.
These entries are created by continuously accessing the [gov.uk/random](https://gov.uk/random) page. This file can be generated by running the `Raw.get_urls()` method, which takes two arguments: count (the number of urls to generate), and file (the name of the file to save to: this should be left as the default `govukurls.txt`). Note that this process can be quite slow as a 5 second gap is required between each query, in order to return a unique URL.

### Is it tested?

Yout bet. Tests are in the <tests/> folder. Either run `python manage.py test` to execute all, (required for database setup and teardown), or you can run individual tests with `python -m unittest tests/test_lookup.py` (for example).

Tests must be run on a postgre data base, so the `TEST_DATABASE_URL` environmental variable must be set in `.env`.

### Common Problems

The following error `AttributeError: 'NoneType' object has no attribute 'drivername'` indicates that the `DEV_DATABASE_URL` environmental variable has not been set.
